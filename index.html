<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lärmkarte Hannover</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 1000px; width: 100%; }
        #time-container {
            text-align: center;
            margin-top: 10px;
        }
        #time-slider {
            width: 300px;
        }
    </style>
</head>
<body>
    <h2>Lärmkarte Hannover</h2>

    <div id="map"></div>

    <!-- Zeitregler unter der Karte -->
    <div id="time-container">
        <label for="time-slider">Uhrzeit:</label>
        <input type="range" id="time-slider" min="0" max="24" step="1" value="0" />
        <span id="slider-label">00:00</span>
    </div>

    <script>
// 1. Karte initialisieren
var map = L.map('map').setView([52.3759, 9.7320], 12);

// 2. OpenStreetMap als Basiskarte hinzufügen
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// 3. Lärmdaten speichern
var laermDaten = JSON.parse(localStorage.getItem('laermDaten')) || [];

// 4. Funktion zur Farbskalierung basierend auf dB-Werten
function getColor(dB) {
    return dB < 50 ? "green" :
           dB < 60 ? "yellowgreen" :
           dB < 70 ? "yellow" :
           dB < 80 ? "orange" :
           dB < 90 ? "orangered" :
           dB < 100 ? "red" : "darkred";
}

// 5. Funktion zum Erstellen eines Hexagon-Rasters
var hexLayer = L.hexbinLayer({
    radius: 50, // Hexagon-Größe ca. 100m
    opacity: 0.6,
    colorScaleExtent: [40, 120],
    colorRange: ["green", "darkred"],
    value: function(d) {
        return d3.mean(d, function(e) { return e[2]; });
    }
}).addTo(map);

// 6. Funktion zur Aktualisierung des Hexagon-Rasters
function updateHexLayer() {
    var points = laermDaten.map(d => [d.lat, d.lng, d.value]);
    hexLayer.data(points);
}

// 7. Marker hinzufügen und färben
function addMarker(lat, lng, value, name) {
    var timestamp = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    var marker = L.circleMarker([lat, lng], {
        radius: 8,
        fillColor: getColor(value),
        color: "#000",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
    }).addTo(map).bindPopup(`Lärmpegel: ${value} dB<br>Zeit: ${timestamp}<br>Jäger: ${name}`);

    laermDaten.push({ lat, lng, value, timestamp, name, marker });
    saveData();
    updateHexLayer();
}

// 8. Funktion zum Speichern der Lärmdaten im localStorage
function saveData() {
    localStorage.setItem('laermDaten', JSON.stringify(laermDaten));
}

// 9. Klick-Event zum Hinzufügen von Lärmdaten
map.on('click', function(e) {
    var lat = e.latlng.lat;
    var lng = e.latlng.lng;
    var value = prompt("Gib den Lärmpegel in dB ein (40-120):");

    if (value !== null) {
        value = parseInt(value);
        if (!isNaN(value) && value >= 40 && value <= 120) {
            var name = prompt("Gib den Jägernamen ein:");
            if (name !== null && name.trim() !== "") {
                addMarker(lat, lng, value, name);
            } else {
                alert("Bitte einen gültigen Jägernamen eingeben.");
            }
        } else {
            alert("Bitte einen gültigen Wert zwischen 40 und 120 dB eingeben.");
        }
    }
});

// 10. Markierungen beim Laden der Seite wiederherstellen
laermDaten.forEach(function(data) {
    var marker = L.circleMarker([data.lat, data.lng], {
        radius: 8,
        fillColor: getColor(data.value),
        color: "#000",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
    }).addTo(map).bindPopup(`Lärmpegel: ${data.value} dB<br>Zeit: ${data.timestamp}<br>Jäger: ${data.name}`);

    data.marker = marker;
});

updateHexLayer();
    </script>
</body>
</html>
