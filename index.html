<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lärmkarte Hannover</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        // Firebase importieren
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Firebase-Konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyBNmZjVFgeqgUdHmcZYzSPV1kTiJSPkUTM",
            authDomain: "laermjaeger.firebaseapp.com",
            projectId: "laermjaeger",
            storageBucket: "laermjaeger.firebasestorage.app",
            messagingSenderId: "738314658200",
            appId: "1:738314658200:web:9557a02160883849b78bed",
            measurementId: "G-1M823BECWK"
        };

        // Firebase initialisieren
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Leaflet-Karte initialisieren
        var map = L.map('map').setView([52.3759, 9.7320], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Farbskala für Lärmpegel
        function getColor(dB) {
            return dB < 50 ? "green" :
                   dB < 60 ? "yellowgreen" :
                   dB < 70 ? "yellow" :
                   dB < 80 ? "orange" :
                   dB < 90 ? "orangered" :
                   dB < 100 ? "red" : "darkred";
        }

        // Marker hinzufügen
        function addMarker(id, lat, lng, value) {
            var color = getColor(value);
            var marker = L.circleMarker([lat, lng], {
                radius: 8,
                fillColor: color,
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map).bindPopup(`Lärmpegel: ${value} dB <br><button onclick="deleteData('${id}')">Löschen</button>`);
        }

        // Bestehende Daten laden
        async function loadData() {
            const querySnapshot = await getDocs(collection(db, "laermDaten"));
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                addMarker(doc.id, data.lat, data.lng, data.value);
            });
        }
        loadData();

        // Klick-Event für neue Einträge
        map.on('click', async function(e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;
            var value = prompt("Gib den Lärmpegel in dB ein (40-120):");

            if (value !== null) {
                value = parseInt(value);
                if (!isNaN(value) && value >= 40 && value <= 120) {
                    const docRef = await addDoc(collection(db, "laermDaten"), { lat, lng, value });
                    addMarker(docRef.id, lat, lng, value);
                } else {
                    alert("Bitte einen gültigen Wert zwischen 40 und 120 dB eingeben.");
                }
            }
        });

        // Löschen (nur du kannst löschen)
        async function deleteData(id) {
            const password = prompt("Admin-Passwort eingeben:");
            if (password === "DEIN_SICHERES_PASSWORT") {
                await deleteDoc(doc(db, "laermDaten", id));
                alert("Eintrag gelöscht! Bitte Seite neu laden.");
            } else {
                alert("Falsches Passwort!");
            }
        }
        window.deleteData = deleteData;
    </script>
</head>
<body>
    <h2>Lärmkarte Hannover</h2>
    <div id="map" style="height: 1000px; width: 100%;"></div>
</body>
</html>
